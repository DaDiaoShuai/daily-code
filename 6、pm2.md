### pm2 æ€ä¹ˆåšè¿›ç¨‹ç®¡ç†ï¼Œè¿›ç¨‹æŒ‚æ‰æ€ä¹ˆå¤„ç†?ä¸ç”¨ pm2 æ€ä¹ˆåšè¿›ç¨‹ç®¡ç†?master æŒ‚äº†çš„è¯ pm2 æ€ä¹ˆå¤„ç†?

> pm2æ˜¯å®ˆæŠ¤nodejsè¿›ç¨‹åå°è¿è¡Œçš„,å¼‚å¸¸åœæ­¢åå¯ä»¥è‡ªåŠ¨é‡å¯ï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥è¢’æŠ¤å…¶å®ƒç¬¬ä¸‰æ–¹çš„å‘½ä»¤è¡Œç¨‹åºï¼Œå®˜æ–¹æ–‡æ¡£ï¼šhttp://pm2.keymetrics.io/docs/usage/quick-start/

#### 1. pm2è¿›ç¨‹ç®¡ç†

##### å®‰è£…

```shell
npm install pm2 -g
```

##### åŸºç¡€å‘½ä»¤

```shell
pm2 start <js|json>  // å¯åŠ¨å¹¶æ·»åŠ ä¸€ä¸ªè¿›ç¨‹
pm2 ls  // æ˜¾ç¤ºæ‰€æœ‰è¿›ç¨‹
pm2 delete <name|id|script|all|json|stdin>  // åœæ­¢å¹¶åˆ é™¤æŒ‡å®šçš„è¿›ç¨‹
// æ­¤è¿›ç¨‹ä½¿ç”¨kill æ— æ•ˆï¼Œå› ä¸ºå­˜åœ¨å®ˆæŠ¤è¿›ç¨‹ï¼Œæ‰€ä»¥æ‰‹åŠ¨killæ‰æŸä¸ªè¿›ç¨‹åä¼šè‡ªåŠ¨é‡å¯
pm2 stop <id|name|all|json|stdin>  // åœæ­¢è¿›ç¨‹
pm2 start <id|name|all|json|stdin>  // å¯åŠ¨æŒ‡å®šè¿›ç¨‹
pm2 restart <id|name|all|json|stdin>  // é‡å¯æŒ‡å®šè¿›ç¨‹ ä¹Ÿå¯ä½¿ç”¨æ­£åˆ™åŒ¹é…å¤šä¸ªè¿›ç¨‹
```

##### æ—¥å¿—

```shell
// 1 å®æ—¶æŸ¥çœ‹æŸè¿›ç¨‹æ—¥å¿—
pm2 logs <id|name|all>
// 2 å½“æ²¡æœ‰æŒ‡å®šæ—¥å¿—ç›®å½•æ—¶ï¼Œé»˜è®¤åœ¨~/.pm2/logsä¸­å­˜æ”¾è¿™æ‰€æœ‰è¿›ç¨‹æ—¥å¿—å†å²

pm2 flush æ¸…ç©ºæ‰€æœ‰å†å²åº”ç”¨æ—¥å¿—
```

##### è´Ÿè½½å‡è¡¡

> pm2åšè´Ÿè½½å‡è¡¡å¤ªçˆ½äº† èµ·é£ğŸ¦

```shell
pm2 start app.js -i <number | max> // å¯åŠ¨æŒ‡å®šæ•°é‡çš„å­è¿›ç¨‹
```

##### é…ç½®æ–‡ä»¶

1. ä½¿ç”¨Generator

```shell
pm2 init  // ç”Ÿæˆ ecosystem.config.js
// æ­¤æ—¶ pm2 start  ||  pm2 start ecosystem.config.js å³å¯ä½¿ç”¨é…ç½®å¯åŠ¨
```

```json
// ecosystem.config.js
// é…ç½®å¤šä¸ªç¯å¢ƒ
module.exports = {
  apps : [{
    name: "app",
    script: "./app.js",
    // log start
    output: "./out.log",
    error: "./error.log",
    log: "./combined.outerr.log",
    log_type: "json", // å°†æ—¥å¿—æŒ‰jsonæ‰“å‡º
    log_date_format: "YYYY-MM-DD",
    merge_logs: true,
    // log end
    // output:  is only standard output (console.log)
    // error: is only error output (console.error)
    // log combines output and error, disabled by default

    // balancing start
    instances: "max",
    // balancing end

    // watch and reload
    watch: true,
    env: {
      NODE_ENV: "development",
    },
    env_production: {
      NODE_ENV: "production",
    }
  }]
}
// é€šè¿‡--env æŒ‡å®šç¯å¢ƒ 
// å½“è¿›ç¨‹è¢«å¯åŠ¨å å…¶ç¯å¢ƒåˆ™ä¸€èˆ¬ä¸å¯å˜ï¼Œå¯é€šè¿‡--update-env å¼ºåˆ¶æ”¹å˜ç¯å¢ƒ
```

2. è‡ªå·±è®¾ç½®é…ç½®æ–‡ä»¶ app.json

```json
[{
    "name": "app",
    "script": "./app.js",
    "error_file": "/data/app-logs/argus/err.log",
    "out_file": "/data/app-logs/argus/out.log",
    "exec_mode": "cluster_mode",  // å•ç‚¹/é›†ç¾¤
    "listen_timeout" : 10000,
    "log_date_format" :"YYYY-MM-DD HH:mm:ss.SSS",
    "env": {
        "NODE_ENV": "production"
    }
}]
```

##### ä¿å­˜è¿›ç¨‹åˆ—è¡¨

```shell
// ~/.pm2/dump.pm2  ||  ~/.pm2/dump.pm2.bak
pm2 dump | save  // ä¿å­˜å½“å‰çš„è¿›ç¨‹åˆ—è¡¨
pm2 resurrect   // æ¢å¤ä¹‹å‰ä¿å­˜çš„è¿›ç¨‹åˆ—è¡¨
```

##### è¿›ç¨‹æŒ‚æ‰äº†æ€ä¹ˆåŠï¼Ÿmaster æŒ‚äº†çš„è¯ pm2 æ€ä¹ˆå¤„ç†?

###### Node.jsåŸç”Ÿé›†ç¾¤æ¨¡å¼

1. å·¥ä½œåŸç†
   
   é›†ç¾¤æ¨¡å—ä¼šåˆ›å»ºä¸€ä¸ªmasterä¸»çº¿ç¨‹ï¼Œç„¶åå¤åˆ¶ä»»æ„å¤šä»½ç¨‹åºå¹¶å¯åŠ¨ï¼Œè¿™å«åšå·¥ä½œçº¿ç¨‹ã€‚ 
   å·¥ä½œçº¿ç¨‹é€šè¿‡ [IPC](https://link.jianshu.com/?t=http%3A%2F%2Fen.wikipedia.org%2Fwiki%2FInter-process_communication) é¢‘é“è¿›è¡Œé€šä¿¡å¹¶ä¸”ä½¿ç”¨äº† [Round-robin algorithm](https://link.jianshu.com/?t=http%3A%2F%2Fen.wikipedia.org%2Fwiki%2FRound-robin_scheduling) ç®—æ³•è¿›è¡Œå·¥ä½œè°ƒåº¦ä»¥æ­¤å®ç°è´Ÿè½½å‡è¡¡ã€‚  
   Round-robinè°ƒåº¦ç­–ç•¥ä¸»è¦æ˜¯masterä¸»çº¿ç¨‹è´Ÿè´£æ¥æ”¶æ‰€æœ‰çš„è¿æ¥å¹¶æ´¾å‘ç»™ä¸‹é¢çš„å„ä¸ªå·¥ä½œçº¿ç¨‹ã€‚

2. ä¸¾ä¸ªä¾‹å­ï¼š
   
   ```javascript
   var cluster = require('cluster');  
   var http    = require('http');  
   var os      = require('os');
   
   var numCPUs = os.cpus().length;
   
   if (cluster.isMaster) {  
    // Master:
    // Let's fork as many workers as you have CPU cores
   
    for (var i = 0; i < numCPUs; ++i) {
      cluster.fork();
    }
   } else {
    // Worker:
    // Let's spawn a HTTP server
    // (Workers can share any TCP connection.
    //  In this case its a HTTP server)
   
    http.createServer(function(req, res) {
      res.writeHead(200);
      res.end("hello world");
    }).listen(8080);
   }
   ```

ä½ å¯ä»¥ä¸å—CPUæ ¸å¿ƒé™åˆ¶çš„åˆ›å»ºä»»æ„å¤šä¸ªå·¥ä½œçº¿ç¨‹ã€‚  
ä½¿ç”¨åŸç”Ÿæ–¹æ³•æœ‰äº›éº»çƒ¦è€Œä¸”ä½ è¿˜éœ€è¦å¤„ç†å¦‚æœæŸä¸ªå·¥ä½œçº¿ç¨‹æŒ‚æ‰äº†ç­‰é¢å¤–çš„é€»è¾‘ã€‚  
(æ³¨ï¼šé€šè¿‡fork()å¤åˆ¶çš„è¿›ç¨‹éƒ½æ˜¯ç‹¬ç«‹çš„è¿›ç¨‹ï¼Œæœ‰ç€å…¨æ–°çš„V8å®ä¾‹)

###### Pm2çš„æ–¹å¼

PM2å†…ç½®äº†å¤„ç†ä¸Šè¿°çš„é€»è¾‘ï¼Œä½ ä¸ç”¨å†å†™è¿™ä¹ˆå¤šç¹ççš„ä»£ç äº†ã€‚  
åªéœ€è¿™æ ·ä¸€è¡Œï¼š

```shell
pm2 start app.js -i 4
// -i <number of workers> è¡¨ç¤ºå®ä¾‹ç¨‹åºçš„ä¸ªæ•°ã€‚å°±æ˜¯å·¥ä½œçº¿ç¨‹ã€‚
// å¦‚æœiä¸º0è¡¨ç¤ºï¼Œä¼šæ ¹æ®å½“å‰CPUæ ¸å¿ƒæ•°åˆ›å»º
```

1.ä¿æŒä½ çš„ç¨‹åºä¸ä¸­æ–­è¿è¡Œ

å¦‚æœæœ‰ä»»ä½•å·¥ä½œçº¿ç¨‹æ„å¤–æŒ‚æ‰äº†ï¼ŒPM2ä¼šç«‹å³é‡å¯ä»–ä»¬ï¼Œå½“å‰ä½ å¯ä»¥åœ¨ä»»ä½•æ—¶å€™é‡å¯ï¼Œåªéœ€ï¼š

```shell
pm2 restart all
```

2.å®æ—¶è°ƒæ•´é›†ç¾¤æ•°é‡

ä½ å¯ä»¥ä½¿ç”¨å‘½ä»¤ `pm2 scale <app name> <n>` è°ƒæ•´ä½ çš„çº¿ç¨‹æ•°é‡ï¼Œ  å¦‚ `pm2 scale app +3` ä¼šåœ¨å½“å‰åŸºç¡€ä¸ŠåŠ 3ä¸ªå·¥ä½œçº¿ç¨‹ã€‚

3.åœ¨ç”Ÿäº§ç¯å¢ƒè®©ä½ çš„ç¨‹åºæ°¸ä¸ä¸­æ–­

`PM2 reload <app name>` å‘½ä»¤ä¼šä¸€ä¸ªæ¥ä¸€ä¸ªçš„é‡å¯å·¥ä½œçº¿ç¨‹ï¼Œåœ¨æ–°çš„å·¥ä½œçº¿ç¨‹å¯åŠ¨åæ‰ç»“æŸè€çš„å·¥ä½œçº¿ç¨‹ã€‚  

è¿™ç§æ–¹å¼å¯ä»¥ä¿æŒä½ çš„Nodeç¨‹åºå§‹ç»ˆæ˜¯è¿è¡ŒçŠ¶æ€ã€‚å³ä½¿åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹éƒ¨ç½²äº†æ–°çš„ä»£ç è¡¥ä¸ã€‚

ä¹Ÿå¯ä»¥ä½¿ç”¨gracefulReloadå‘½ä»¤è¾¾åˆ°åŒæ ·çš„ç›®çš„ï¼Œå®ƒä¸ä¼šç«‹å³ç»“æŸå·¥ä½œçº¿ç¨‹ï¼Œè€Œæ˜¯é€šè¿‡IPCå‘å®ƒå‘é€å…³é—­ä¿¡å·ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥å…³é—­æ­£åœ¨è¿›è¡Œçš„è¿æ¥ï¼Œè¿˜å¯ä»¥åœ¨é€€å‡ºä¹‹å‰æ‰§è¡Œä¸€äº›è‡ªå®šä¹‰ä»»åŠ¡ã€‚è¿™ç§æ–¹å¼æ›´ä¼˜é›…ã€‚

```javascript
process.on('message', function(msg) {  
  if (msg === 'shutdown') {
    close_all_connections();
    delete_cache();
    server.close();
    process.exit(0);
  }
});
```

#### 2. ä¸ç”¨ pm2 æ€ä¹ˆåšè¿›ç¨‹ç®¡ç†?

##### node-forever

ä½¿ç”¨`forever start simple-server.js`ï¼Œæ ¸å¿ƒåœ¨äº[forever-monitor](https://github.com/foreversd/forever-monitor/blob/master/lib/forever-monitor/monitor.js)ï¼Œå…¶åŸç†å°±æ˜¯å´©æºƒå°±é‡å¯ä¸€ä¸ª

```javascript
Monitor.prototype.start = function (restart) {
  var self = this,
      child;

  // éé‡å¯åˆ™è¿”å›è‡ªèº«è¿›ç¨‹
  if (this.running && !restart) {
    process.nextTick(function () {
      self.emit('error', new Error('Cannot start process that is already running.'));
    });
    return this;
  }

  // é‡å¯æ ‡å¿—ä¼ å…¥æ—¶ï¼Œé‡æ–° fork è¿›ç¨‹ï¼Œæ–¹æ³•é‡Œä½¿ç”¨äº† child_process.spawn æ‰§è¡Œå‘½ä»¤æ¥è¡ç”Ÿä¸€ä¸ªæ–°è¿›ç¨‹
  child = this.trySpawn();
  if (!child) {
    process.nextTick(function () {
      self.emit('error', new Error('Target script does not exist: ' + self.args[0]));
    });
    return this;
  }

  this.ctime = Date.now();
  this.child = child;
  this.running = true;
  this.isMaster = cluster.isMaster;

  process.nextTick(function () {
    self.emit(restart ? 'restart' : 'start', self, self.data);
  });

  function onMessage(msg) {
    self.emit('message', msg);
  }

  // Re-emit messages from the child process
  this.child.on('message', onMessage);

  // ç›‘å¬é€€å‡ºäº‹ä»¶ï¼Œå´©æºƒæ—¶é€€å‡ºä¹Ÿç®—ã€‚
  child.on('exit', function (code, signal) {
    var spinning = Date.now() - self.ctime < self.minUptime;
    child.removeListener('message', onMessage);
    self.emit('exit:code', code, signal);

    function letChildDie() {
      self.running = false;
      self.forceStop = false;
      self.emit('exit', self, spinning);
    }

    function restartChild() {
      self.forceRestart = false;
      process.nextTick(function () {
        self.start(true);
      });
    }

    self.times++;

    // å¼ºåˆ¶å…³é—­ï¼Œå½“é‡å¯æ¬¡æ•°è¿‡å¤š
    if (self.forceStop || (self.times >= self.max && !self.forceRestart)
      || (spinning && typeof self.spinSleepTime !== 'number') && !self.forceRestart) {
      letChildDie();
    }
    // æŒ‰ç…§æœ€å°çš„é‡å¯æ—¶é—´é—´éš”ï¼Œé˜²æ­¢ä¸åœå´©æºƒé‡å¯
    else if (spinning) {
      setTimeout(restartChild, self.spinSleepTime);
    }
    else {
      restartChild();
    }
  });

  // è¿”å›é‡å¯åçš„æ–°è¿›ç¨‹
  return this;
};
```

##### shellè„šæœ¬å¯åŠ¨å®ˆæŠ¤Node.js

```shell
WEB_DIR='/var/www/ourjs'
WEB_APP='svr/ourjs.js'

#location of node you want to use
NODE_EXE=/root/local/bin/node

while true; do
    {
        $NODE_EXE $WEB_DIR/$WEB_APP config.magazine.js
        echo "Stopped unexpected, restarting \r\n\r\n"
    } 2>> $WEB_DIR/error.log
    sleep 1
done
```

è¿™ä¸ªæ–‡ä»¶éå¸¸ç®€å•ï¼Œåªæœ‰å¯åŠ¨çš„é€‰é¡¹ï¼Œå®ˆæŠ¤çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ç”±ä¸€ä¸ªæ— é™å¾ªç¯ while true; æ¥å®ç°çš„ï¼Œä¸ºäº†é˜²æ­¢è¿‡äºå¯†é›†çš„é”™è¯¯é˜»å¡è¿›ç¨‹ï¼Œæ¯æ¬¡é”™è¯¯åé—´éš”1ç§’é‡å¯æœåŠ¡ã€‚é”™è¯¯æ—¥å¿—è®°å½•ä¹Ÿéå¸¸ç®€å•ï¼Œç›´æ¥å°†æ­¤è¿›ç¨‹æ§åˆ¶å°å½“ä¸­çš„é”™è¯¯è¾“å‡ºåˆ°error.logæ–‡ä»¶å³å¯ï¼š 2>> $WEB_DIR/error.log è¿™ä¸€è¡Œ, 2 ä»£è¡¨ Error

##### cluster API

Node åŸç”Ÿæä¾›äº† clusterï¼Œå¯ä»¥åˆ›å»ºå…±äº«æœåŠ¡å™¨ç«¯å£çš„å­è¿›ç¨‹ã€‚å°±å¦‚ [EggJS å®˜ç½‘å¤šè¿›ç¨‹æ¨¡å‹çš„è¯´æ˜](https://eggjs.org/zh-cn/core/cluster-and-ipc.html)

```
+---------+                 +---------+
|  Worker |                 |  Master |
+---------+                 +----+----+
     | uncaughtException         |
     +------------+              |
     |            |              |                   +---------+
     | <----------+              |                   |  Worker |
     |                           |                   +----+----+
     |        disconnect         |   fork a new worker    |
     +-------------------------> + ---------------------> |
     |         wait...           |                        |
     |          exit             |                        |
     +-------------------------> |                        |
     |                           |                        |
    die                          |                        |
                                 |                        |
                                 |                        |
```

å¯ä»¥å†ä¸šåŠ¡ä»£ç ä¹‹ä¸Šèµ·ä¸€ä¸ª master è¿›ç¨‹ï¼Œä»– fork å‡ºå¤šä¸ª worker è¿›ç¨‹æ¥å¤„ç†ä»»åŠ¡ï¼Œæ¯å½“ä¸€ä¸ª worker æŒ‚äº†ï¼Œä¼šæœ‰äº‹ä»¶ä¼ å›ç»™ masterï¼Œmaster å°±èƒ½é‡æ–° fork ä¸€ä»½æ–°çš„ workerã€‚

é‚£ä¹ˆåªè¦ master ä¸æŒ‚ï¼Œå°±èƒ½è¾¾åˆ°å®ˆæŠ¤è¿›ç¨‹çš„ç›®çš„ã€‚

#### ç»“è®º

Node.jsç”¨æˆ·ä½¿ç”¨pm2çš„ä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼š

- æ“ä½œç³»ç»Ÿé™åˆ¶ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜
- å†…å­˜ï¼šæ— æ³•å……åˆ†åˆ©ç”¨æœºå™¨å…¨éƒ¨å†…å­˜
- CPUï¼šæ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU çš„ä¼˜åŠ¿

ğŸššä¸Šè½¦å§ï¼Œè¿˜åœ¨ç­‰ä»€ä¹ˆ
